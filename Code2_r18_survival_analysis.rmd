---
title: " Yaohua Ma, M.S \\\nDivision of Biomedical Statistics and Informatics \\\nMayo Clinic, Jacksonville \\\nExtension 3-0453    \\\nMa.Yaohua@mayo.edu"


subtitle: "Date:      08/20/2020	\\\n From:    Yaohua Ma  \\\nTo:      Dr. Thompson  \\\nRe:       FinXX DSP  re-analysis 17 extended target proteins (ADS#214070)"


output: 
   word_document:
           reference_doc: ~/R/rpgm/rmd_template2.docx 
           
---
# 
NOTES :
1:  Still working on the previous same FinXX HK3normalized data, Run survival analysis separately  In 8 data set (all tumor, all stroma, CD45 tumor, CD68 tumor , tumortumor, CD45 stroma, CD68 stroma, all segment)

2:  Find HR95%ci by  high vs low and mid vs low tertiles on each data

3:  Generate  the KM survival curves corresponding to the above HR analysis based on each data set (total 8 data set) (considering 17 proteins with  3 tertiles group,  and the 17 proteins are : 1.HLA-DR	2. IDO-1	3. CD27	4.CD40	5. CD56	6. CD11c.	7. GZMB	 8.PD-L1	9. PD-L2	 10.CD20	11.CD3	12. CD4 	13. CTLA4	14. SMA	 15. CD45	16. ICOS	17. FN (Fibronectin))

4:  Run single variable cox model for HR first,  then later to  decide  which protein is good to be adjusted variable in the multivariate cox regression model for HR calculation if needed . 

5: Kaplan Meier Survival curve for RFS based on 8 ordered Finxx DSP data set  ( 1)all tumor, 2)all stroma, 3)CD45tumor, 4)CD68tumor, 5)tumortumor, 6)CD45stroma, 7)CD68stroma, 8)all segments)


<!-- 1.	 HLA-DR -->
<!-- 2.	IDO-1 -->
<!-- 3.	CD14  no included in FINxx , so total 17 proteins-->
<!-- 4.	CD27 -->
<!-- 5.	CD40 -->
<!-- 6.	CD56 -->
<!-- 7.	CD11c.  -->
<!-- 8.	GZMB -->
<!-- 9.	PD-L1 -->
<!-- 10.	PD-L2 -->
<!-- 11.	 CD20 -->
<!-- 12.	CD3 -->
<!-- 13.	CD4  -->
<!-- 14.	CTLA4 -->
<!-- 15.	SMA -->
<!-- 16.	CD45 -->
<!-- 17.	ICOS -->
<!-- 18.	FN (fibronectin) -->


```{r setup, include=FALSE ,echo = FALSE,  warning=FALSE, message=FALSE}
##################################################### part 1 find forest plot   ##############################
library(ggplot2)
library(readxl)
library(writexl)
library(tidyverse)
library(dplyr)
library(MASS)
library(tidypredict)
setwd("/projects/bsi/fl/studies/s214070.Thompson.DSP2")

## 29 protein tumor vs stroma, log2FC
d1 <-  read_xlsx ("re_analyze_FinXX950/output/r12_FinXX_DSP950_meanbyclinicID.xlsx", sheet = "Sheet1") 
d2 <-  read_xlsx ("re_analyze_FinXX950/output/r12_FinXX_DSP950_meanbyclinicID.xlsx", sheet = "Sheet2")
d3 <-  read_xlsx ("re_analyze_FinXX950/output/r12_FinXX_DSP950_meanbyclinicID.xlsx", sheet = "Sheet3")
d4 <-  read_xlsx ("re_analyze_FinXX950/output/r12_FinXX_DSP950_meanbyclinicID.xlsx", sheet = "Sheet4")
d5 <-  read_xlsx ("re_analyze_FinXX950/output/r12_FinXX_DSP950_meanbyclinicID.xlsx", sheet = "Sheet5")
d6 <-  read_xlsx ("re_analyze_FinXX950/output/r12_FinXX_DSP950_meanbyclinicID.xlsx", sheet = "Sheet6")
d7 <-  read_xlsx ("re_analyze_FinXX950/output/r12_FinXX_DSP950_meanbyclinicID.xlsx", sheet = "Sheet7")
d8 <-  read_xlsx ("re_analyze_FinXX950/output/r12_FinXX_DSP950_meanbyclinicID.xlsx", sheet = "Sheet8")
## above read original data , mean by clinic id based on each cohort segments

fun_mutate_gp <- function(dat) {
   library(tidyverse)
library(dplyr)
library(MASS)
  dat <- as.data.frame(dat)
  
  vars <- colnames(dat)
ct_v <- c("PatientID",               "pT_TumorSizeScore" ,      "pN_LymphNodeStatusScore",  "HistologicalGrade",       "ER_status",       
          "PR_status",               "HER2_status",                            "DSP_used_or_not")

dat[ct_v] <- lapply(dat[ct_v], factor)
cn_v <- vars[!(vars %in% ct_v)]  ## same as : cn_v <- vars[ vars %nin% ct_v]
dat[cn_v] <- lapply(dat[cn_v], function(x) as.numeric(as.character(x)))  

  dat <-  dat %>% dplyr::mutate(RFS_c = 1-Censor_RFS,
                                RFS_years =RFS_days/365.25)

  
 x <- dat$HLA_DR     ## protein 1----------------------
tertile <- quantile(x, probs = c(0.333, 0.667), na.rm=TRUE)
dat <-  dat %>% mutate(HLA_DR_ = case_when(
  HLA_DR < tertile[1] ~ "lower",
  HLA_DR >= tertile[1] &  HLA_DR < tertile[2] ~ "middle",
  HLA_DR >= tertile[2] ~ "upper"))
dat$HLA_DR_ <- factor(dat$HLA_DR_, levels = c("lower", "middle", "upper"), labels = c("low", "mid", "high"))  

 x <- dat$IDO1     ## protein 2-----------------------------
tertile <- quantile(x, probs = c(0.333, 0.667), na.rm=TRUE)
dat <-  dat %>% mutate(IDO1_ = case_when(
  IDO1 < tertile[1] ~ "lower",
  IDO1 >= tertile[1] &  IDO1 < tertile[2] ~ "middle",
  IDO1 >= tertile[2] ~ "upper"))
dat$IDO1_ <- factor(dat$IDO1_, levels = c("lower", "middle", "upper"), labels = c("low", "mid", "high"))  
 
#  x <- dat$CD14  ## protein 3------------------
# tertile <- quantile(x, probs = c(0.333, 0.667), na.rm=TRUE)
# dat <-  dat %>% mutate(CD14_ = case_when(
#   CD14 < tertile[1] ~ "lower",
#   CD14 >= tertile[1] &  CD14 < tertile[2] ~ "middle",
#   CD14 >= tertile[2] ~ "upper"))
# dat$CD14_ <- factor(dat$CD14_, levels = c("lower", "middle", "upper"), labels = c("low", "mid", "high"))

 x <- dat$CD27 ## protein 4------------------
tertile <- quantile(x, probs = c(0.333, 0.667), na.rm=TRUE)
dat <-  dat %>% mutate(CD27_ = case_when(
  CD27 < tertile[1] ~ "lower",
  CD27 >= tertile[1] &  CD27 < tertile[2] ~ "middle",
  CD27 >= tertile[2] ~ "upper"))
dat$CD27_ <- factor(dat$CD27_, levels = c("lower", "middle", "upper"), labels = c("low", "mid", "high"))


  x <- dat$CD40 ## protein 5------------------
tertile <- quantile(x, probs = c(0.333, 0.667), na.rm=TRUE)
dat <-  dat %>% mutate(CD40_ = case_when(
  CD40 < tertile[1] ~ "lower",
  CD40 >= tertile[1] &  CD40 < tertile[2] ~ "middle",
  CD40 >= tertile[2] ~ "upper"))
dat$CD40_ <- factor(dat$CD40_, levels = c("lower", "middle", "upper"), labels = c("low", "mid", "high"))

 x <- dat$CD56 ## protein 6------------------
tertile <- quantile(x, probs = c(0.333, 0.667), na.rm=TRUE)
dat <-  dat %>% mutate(CD56_ = case_when(
  CD56 < tertile[1] ~ "lower",
  CD56 >= tertile[1] &  CD56 < tertile[2] ~ "middle",
  CD56 >= tertile[2] ~ "upper"))
dat$CD56_ <- factor(dat$CD56_, levels = c("lower", "middle", "upper"), labels = c("low", "mid", "high"))

x <- dat$CD11c ## protein 7------------------
tertile <- quantile(x, probs = c(0.333, 0.667), na.rm=TRUE)
dat <-  dat %>% mutate(CD11c_ = case_when(
  CD11c < tertile[1] ~ "lower",
  CD11c >= tertile[1] &  CD11c < tertile[2] ~ "middle",
  CD11c >= tertile[2] ~ "upper"))
dat$CD11c_ <- factor(dat$CD11c_, levels = c("lower", "middle", "upper"), labels = c("low", "mid", "high"))


x <- dat$GZMB  ## protein 8------------------
tertile <- quantile(x, probs = c(0.333, 0.667), na.rm=TRUE)
dat <-  dat %>% mutate(GZMB_ = case_when(
  GZMB < tertile[1] ~ "lower",
  GZMB >= tertile[1] &  GZMB < tertile[2] ~ "middle",
  GZMB >= tertile[2] ~ "upper"))
dat$GZMB_ <- factor(dat$GZMB_, levels = c("lower", "middle", "upper"), labels = c("low", "mid", "high"))


 x <- dat$PD_L1 ## protein 9------------------
tertile <- quantile(x, probs = c(0.333, 0.667), na.rm=TRUE)
dat <-  dat %>% mutate(PD_L1_ = case_when(
  PD_L1 < tertile[1] ~ "lower",
  PD_L1 >= tertile[1] &  PD_L1 < tertile[2] ~ "middle",
  PD_L1 >= tertile[2] ~ "upper"))
dat$PD_L1_ <- factor(dat$PD_L1_, levels = c("lower", "middle", "upper"), labels = c("low", "mid", "high")) 

 x <- dat$PD_L2  ## protein 10-----------------
tertile <- quantile(x, probs = c(0.333, 0.667), na.rm=TRUE)
dat <-  dat %>% mutate(PD_L2_ = case_when(
  PD_L2 < tertile[1] ~ "lower",
  PD_L2 >= tertile[1] &  PD_L2 < tertile[2] ~ "middle",
  PD_L2 >= tertile[2] ~ "upper"))
dat$PD_L2_ <- factor(dat$PD_L2_, levels = c("lower", "middle", "upper"), labels = c("low", "mid", "high")) 

x <- dat$CD20 ## protein 11------------------
tertile <- quantile(x, probs = c(0.333, 0.667), na.rm=TRUE)
dat <-  dat %>% mutate(CD20_ = case_when(
  CD20 < tertile[1] ~ "lower",
  CD20 >= tertile[1] &  CD20 < tertile[2] ~ "middle",
  CD20 >= tertile[2] ~ "upper"))
dat$CD20_ <- factor(dat$CD20_, levels = c("lower", "middle", "upper"), labels = c("low", "mid", "high"))

x <- dat$CD3 ## protein 12------------------
tertile <- quantile(x, probs = c(0.333, 0.667), na.rm=TRUE)
dat <-  dat %>% mutate(CD3_ = case_when(
  CD3 < tertile[1] ~ "lower",
  CD3 >= tertile[1] &  CD3 < tertile[2] ~ "middle",
  CD3 >= tertile[2] ~ "upper"))
dat$CD3_ <- factor(dat$CD3_, levels = c("lower", "middle", "upper"), labels = c("low", "mid", "high"))



  
  x <- dat$CD4 ## protein 13------------------
tertile <- quantile(x, probs = c(0.333, 0.667), na.rm=TRUE)
dat <-  dat %>% mutate(CD4_ = case_when(
  CD4 < tertile[1] ~ "lower",
  CD4 >= tertile[1] &  CD4 < tertile[2] ~ "middle",
  CD4 >= tertile[2] ~ "upper"))
dat$CD4_ <- factor(dat$CD4_, levels = c("lower", "middle", "upper"), labels = c("low", "mid", "high"))
  
x <- dat$CTLA4 ## protein 14------------------
tertile <- quantile(x, probs = c(0.333, 0.667), na.rm=TRUE)
dat <-  dat %>% mutate(CTLA4_ = case_when(
  CTLA4 < tertile[1] ~ "lower",
  CTLA4 >= tertile[1] &  CTLA4 < tertile[2] ~ "middle",
  CTLA4 >= tertile[2] ~ "upper"))
dat$CTLA4_ <- factor(dat$CTLA4_, levels = c("lower", "middle", "upper"), labels = c("low", "mid", "high"))


x <- dat$SMA   ## protein 15------------------
tertile <- quantile(x, probs = c(0.333, 0.667), na.rm=TRUE)
dat <-  dat %>% mutate(SMA_ = case_when(
  SMA < tertile[1] ~ "lower",
  SMA >= tertile[1] &  SMA < tertile[2] ~ "middle",
  SMA >= tertile[2] ~ "upper"))
dat$SMA_ <- factor(dat$SMA_, levels = c("lower", "middle", "upper"), labels = c("low", "mid", "high")) 


 x <- dat$CD45 ## protein 16------------------
tertile <- quantile(x, probs = c(0.333, 0.667), na.rm=TRUE)
dat <-  dat %>% mutate(CD45_ = case_when(
  CD45 < tertile[1] ~ "lower",
  CD45 >= tertile[1] &  CD45 < tertile[2] ~ "middle",
  CD45 >= tertile[2] ~ "upper"))
dat$CD45_ <- factor(dat$CD45_, levels = c("lower", "middle", "upper"), labels = c("low", "mid", "high"))
  

x <- dat$ICOS  ## protein 17------------------
tertile <- quantile(x, probs = c(0.333, 0.667), na.rm=TRUE)
dat <-  dat %>% mutate(ICOS_ = case_when(
  ICOS < tertile[1] ~ "lower",
  ICOS >= tertile[1] &  ICOS < tertile[2] ~ "middle",
 ICOS >= tertile[2] ~ "upper"))
dat$ICOS_ <- factor(dat$ICOS_, levels = c("lower", "middle", "upper"), labels = c("low", "mid", "high")) 



x <- dat$Fibronectin ## protein 18------------------
tertile <- quantile(x, probs = c(0.333, 0.667), na.rm=TRUE)
dat <-  dat %>% mutate(Fibronectin_ = case_when(
  Fibronectin < tertile[1] ~ "lower",
  Fibronectin >= tertile[1] &  Fibronectin < tertile[2] ~ "middle",
  Fibronectin >= tertile[2] ~ "upper"))
dat$Fibronectin_ <- factor(dat$Fibronectin_, levels = c("lower", "middle", "upper"), labels = c("low", "mid", "high")) 



return(dat)
}

dat1 <- fun_mutate_gp(d1)
dat2 <- fun_mutate_gp(d2)
dat3 <- fun_mutate_gp(d3)
dat4 <- fun_mutate_gp(d4)
dat5 <- fun_mutate_gp(d5)
dat6 <- fun_mutate_gp(d6)
dat7 <- fun_mutate_gp(d7)
dat8 <- fun_mutate_gp(d8)




```

```{r    echo = FALSE,  warning=FALSE, message=FALSE}
## builb survival  curve function -------------------------------------------------------------------------
# 1.	 HLA-DR --------------------------------------------------------------------------

fun_survcurveHLA_DR <- function(dat) {
    library(survival)
    library(survminer)
      os_fit <- survfit(Surv(time=RFS_years , event=RFS_c) ~ HLA_DR_  , data=dat) ## do not use dat <- as.data.frame(dat),otherwise wrong
      os <- ggsurvplot(os_fit,
                 fun=function(y) y*100,
                 #fun = function(x) {1 - x},
                 xlab="RFS_years",   ylab="Estimated Survival Probability (%)",
                 linetype = c(1, 1, 1), palette=c("red", "blue", "black"), legend.title="",
                 legend = c(0.2,0.22), legend.labs=c( "HLA-DR_low", "HLA-DR_mid", "HLA-DR_high"),
                 font.legend = c(10, "bold", "black"), censor = FALSE,
                 risk.table = TRUE,
                 risk.table.title = "                                      Number at Risk",
                 risk.table.fontsize = 4.5,  risk.table.height =.15,
                 font.x = c(12, "bold", "black"),  ## can be "bold.italic",
                 font.y = c(12, "bold", "black"),   ## can be "red", "darked"
                 font.tickslab = c(12, "bold", "black"),  break.time.by=2,  xlim=c(0, 10),  pval=TRUE,
                 ylim=c(0,100),  pval.coord = c(1, 1.5),  pval.size = 4.5,   title="  ",
                 tables.theme=theme_cleantable(),   axes.offset=TRUE,  tables.y.text=FALSE)
      os$plot <- os$plot + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                           plot.title= element_text(hjust=.5),
                           axis.text = element_text( color="black", size = 12, face="bold"))+
           theme(#legend.position="right",
          legend.title = element_text(colour="black", size=10,  face="bold") ,
          legend.text = element_text(colour="black", size=10,  face="bold"))
     os$table <- os$table +
             theme(plot.title = element_text(size = 12, color = "black", face = "bold", hjust = -0.25),
              plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
               legend.text = element_text(colour="black", size=12,  face="bold"))
      print(os)
}



# 2.	IDO-1 --------------------------------------------------------------------------

fun_survcurveIDO1 <- function(dat) {
library(survival)
library(survminer)
os_fit <- survfit(Surv(time=RFS_years , event=RFS_c) ~ IDO1_  , data=dat) ## do not use dat <- as.data.frame(dat),otherwise wrong

os <- ggsurvplot(os_fit,  fun=function(y) y*100,  xlab="RFS_years",   ylab="Estimated Survival Probability (%)",
                 linetype = c(1, 1, 1), palette=c("red", "blue", "black"), legend.title="",  legend = c(0.11,0.2),
                 legend.labs=c( "IDO-1_low", "IDO-1_mid", "IDO-1_high"), font.legend = c(10, "bold", "black"),
                 censor = FALSE,  risk.table = TRUE,
                 risk.table.title = "                                      Number at Risk",
                 risk.table.fontsize = 4.5, risk.table.height =.15,
                 font.x = c(12, "bold", "black"),  font.y = c(12, "bold", "black"),   ## can be "red", "darked" ## can be "bold.italic"
                 font.tickslab = c(12, "bold", "black"), break.time.by=2, xlim=c(0, 10),  ylim=c(0,100), pval=TRUE,
                 pval.coord = c(0.2, 1.5),  pval.size = 4.5, title="  ",
                 tables.theme=theme_cleantable(), axes.offset=TRUE, tables.y.text=FALSE)

os$plot <- os$plot + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                           plot.title= element_text(hjust=.5,color="black", size = 12, face="bold"),
                           axis.text = element_text( color="black", size = 12, face="bold"),
                           legend.title = element_text(colour="black", size=10,  face="bold") ,
                           legend.text = element_text(colour="black", size=10,  face="bold"))    # chenge high low
             #  annotate("text", x = 10, y = 15, label = "P-value",  vjust=0, hjust = 1.1, face = "bold", fontface=16)  ## add some the figure
             #  legend.position="right",
os$table <- os$table + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                   plot.title = element_text(size = 12, color = "black", face = "bold", hjust = -0.25), 
                   legend.text = element_text(colour="black", size=12,  face="bold"))
print(os)
}

# 3.	CD14-------------------------------not included in FInxx data-----------------------------
# 4.	CD27--------------------------------------------------------------------------
fun_survcurveCD27 <- function(dat) {
library(survival)
library(survminer)
os_fit <- survfit(Surv(time=RFS_years , event=RFS_c) ~ CD27_  , data=dat) ## do not use dat <- as.data.frame(dat),otherwise wrong

os <- ggsurvplot(os_fit,  fun=function(y) y*100,  xlab="RFS_years",   ylab="Estimated Survival Probability (%)",
                 linetype = c(1, 1, 1), palette=c("red", "blue", "black"), legend.title="",  legend = c(0.11,0.2),
                 legend.labs=c( "CD27_low", "CD27_mid", "CD27_high"), font.legend = c(10, "bold", "black"),
                 censor = FALSE,  risk.table = TRUE,
                 risk.table.title = "                                      Number at Risk",
                 risk.table.fontsize = 4.5, risk.table.height =.15,
                 font.x = c(12, "bold", "black"),  font.y = c(12, "bold", "black"),   ## can be "red", "darked" ## can be "bold.italic"
                 font.tickslab = c(12, "bold", "black"), break.time.by=2, xlim=c(0, 10),  ylim=c(0,100), pval=TRUE,
                 pval.coord = c(0.2, 1.5),  pval.size = 4.5, title="  ",
                 tables.theme=theme_cleantable(), axes.offset=TRUE, tables.y.text=FALSE)

os$plot <- os$plot + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                           plot.title= element_text(hjust=.5,color="black", size = 12, face="bold"),
                           axis.text = element_text( color="black", size = 12, face="bold"),
                           legend.title = element_text(colour="black", size=10,  face="bold") ,
                           legend.text = element_text(colour="black", size=10,  face="bold"))    # chenge high low
             #  annotate("text", x = 10, y = 15, label = "P-value",  vjust=0, hjust = 1.1, face = "bold", fontface=16)  ## add some the figure
             #  legend.position="right",
os$table <- os$table + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                   plot.title = element_text(size = 12, color = "black", face = "bold", hjust = -0.25), 
                   legend.text = element_text(colour="black", size=12,  face="bold"))
print(os)
}

# 5.	CD40--------------------------------------------------------------------------
fun_survcurveCD40 <- function(dat) {
library(survival)
library(survminer)
os_fit <- survfit(Surv(time=RFS_years , event=RFS_c) ~ CD40_  , data=dat) ## do not use dat <- as.data.frame(dat),otherwise wrong

os <- ggsurvplot(os_fit,  fun=function(y) y*100,  xlab="RFS_years",   ylab="Estimated Survival Probability (%)",
                 linetype = c(1, 1, 1), palette=c("red", "blue", "black"), legend.title="",  legend = c(0.11,0.2),
                 #legend.labs=c( "CD40_low", "CD40_mid", "CD40_high"), 
                 font.legend = c(10, "bold", "black"),
                 censor = FALSE,  risk.table = TRUE,
                 risk.table.title = "                                      Number at Risk",
                 risk.table.fontsize = 4.5, risk.table.height =.15,
                 font.x = c(12, "bold", "black"),  font.y = c(12, "bold", "black"),   ## can be "red", "darked" ## can be "bold.italic"
                 font.tickslab = c(12, "bold", "black"), break.time.by=2, xlim=c(0, 10),  ylim=c(0,100), pval=TRUE,
                 pval.coord = c(0.2, 1.5),  pval.size = 4.5, title="  ",
                 tables.theme=theme_cleantable(), axes.offset=TRUE, tables.y.text=FALSE)

os$plot <- os$plot + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                           plot.title= element_text(hjust=.5,color="black", size = 12, face="bold"),
                           axis.text = element_text( color="black", size = 12, face="bold"),
                           legend.title = element_text(colour="black", size=10,  face="bold") ,
                           legend.text = element_text(colour="black", size=10,  face="bold"))    # chenge high low
             #  annotate("text", x = 10, y = 15, label = "P-value",  vjust=0, hjust = 1.1, face = "bold", fontface=16)  ## add some the figure
             #  legend.position="right",
os$table <- os$table + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                   plot.title = element_text(size = 12, color = "black", face = "bold", hjust = -0.25), 
                   legend.text = element_text(colour="black", size=12,  face="bold"))
print(os)
}
# 6.	CD56--------------------------------------------------------------------------
fun_survcurveCD56 <- function(dat) {
library(survival)
library(survminer)
os_fit <- survfit(Surv(time=RFS_years , event=RFS_c) ~ CD56_  , data=dat) ## do not use dat <- as.data.frame(dat),otherwise wrong

os <- ggsurvplot(os_fit,  fun=function(y) y*100,  xlab="RFS_years",   ylab="Estimated Survival Probability (%)",
                 linetype = c(1, 1, 1), palette=c("red", "blue", "black"), legend.title="",  legend = c(0.11,0.2),
                 legend.labs=c( "CD56_low", "CD56_mid", "CD56_high"), font.legend = c(10, "bold", "black"),
                 censor = FALSE,  risk.table = TRUE,
                 risk.table.title = "                                      Number at Risk",
                 risk.table.fontsize = 4.5, risk.table.height =.15,
                 font.x = c(12, "bold", "black"),  font.y = c(12, "bold", "black"),   ## can be "red", "darked" ## can be "bold.italic"
                 font.tickslab = c(12, "bold", "black"), break.time.by=2, xlim=c(0, 10),  ylim=c(0,100), pval=TRUE,
                 pval.coord = c(0.2, 1.5),  pval.size = 4.5, title="  ",
                 tables.theme=theme_cleantable(), axes.offset=TRUE, tables.y.text=FALSE)

os$plot <- os$plot + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                           plot.title= element_text(hjust=.5,color="black", size = 12, face="bold"),
                           axis.text = element_text( color="black", size = 12, face="bold"),
                           legend.title = element_text(colour="black", size=10,  face="bold") ,
                           legend.text = element_text(colour="black", size=10,  face="bold"))    # chenge high low
             #  annotate("text", x = 10, y = 15, label = "P-value",  vjust=0, hjust = 1.1, face = "bold", fontface=16)  ## add some the figure
             #  legend.position="right",
os$table <- os$table + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                   plot.title = element_text(size = 12, color = "black", face = "bold", hjust = -0.25), 
                   legend.text = element_text(colour="black", size=12,  face="bold"))
print(os)
}




```



```{r echo = FALSE,  warning=FALSE, message=FALSE}
# 7.	CD11c. --------------------------------------------------------------------------
fun_survcurveCD11c <- function(dat) {
library(survival)
library(survminer)
os_fit <- survfit(Surv(time=RFS_years , event=RFS_c) ~ CD11c_  , data=dat) ## do not use dat <- as.data.frame(dat),otherwise wrong

os <- ggsurvplot(os_fit,  fun=function(y) y*100,  xlab="RFS_years",   ylab="Estimated Survival Probability (%)",
                 linetype = c(1, 1, 1), palette=c("red", "blue", "black"), legend.title="",  legend = c(0.14,0.23),
                 legend.labs=c( "CD11c_low", "CD11c_mid", "CD11c_high"), font.legend = c(10, "bold", "black"),
                 censor = FALSE,  risk.table = TRUE,
                 risk.table.title = "                                      Number at Risk",
                 risk.table.fontsize = 4.5, risk.table.height =.15,
                 font.x = c(12, "bold", "black"),  font.y = c(12, "bold", "black"),   ## can be "red", "darked" ## can be "bold.italic"
                 font.tickslab = c(12, "bold", "black"), break.time.by=2, xlim=c(0, 10),  ylim=c(0,100), pval=TRUE,
                 pval.coord = c(0.2, 1.5),  pval.size = 4.5, title="  ",
                 tables.theme=theme_cleantable(), axes.offset=TRUE, tables.y.text=FALSE)

os$plot <- os$plot + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                           plot.title= element_text(hjust=.5,color="black", size = 12, face="bold"),
                           axis.text = element_text( color="black", size = 12, face="bold"),
                           legend.title = element_text(colour="black", size=12,  face="bold") ,
                           legend.text = element_text(colour="black", size=12,  face="bold"))    # chenge high low
             #  annotate("text", x = 10, y = 15, label = "P-value",  vjust=0, hjust = 1.1, face = "bold", fontface=16)  ## add some the figure
             #  legend.position="right",
os$table <- os$table + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                   plot.title = element_text(size = 12, color = "black", face = "bold", hjust = -0.25), 
                   legend.text = element_text(colour="black", size=12,  face="bold"))
print(os)
}


## builb survival  curve function for GZMB---------------------------------------------------------------------------------------
# 8.	GZMB--------------------------------------------------------------------------

fun_survcurveGZMB <- function(dat) {
 
library(survival)
library(survminer)
os_fit <- survfit(Surv(time=RFS_years , event=RFS_c) ~ GZMB_  , data=dat)
os <- ggsurvplot(os_fit,
                 fun=function(y) y*100,
                 #fun = function(x) {1 - x},
                 xlab="RFS_years",
                 ylab="Estimated Survival Probability (%)",
                 linetype = c(1, 1, 1),
                 palette=c("red", "blue", "black"),
                 legend.title="",
                 legend = c(0.14,0.23),
                 legend.labs=c( "GZMB_low", "GZMB_mid", "GZMB_high"),
                 font.legend = c(10, "bold", "black"),
                 censor = FALSE,
                 risk.table = TRUE,
                 risk.table.title = "                                      Number at Risk",
                 risk.table.fontsize = 4.5,
                 risk.table.height =.15,
                 font.x = c(12, "bold", "black"),  ## can be "bold.italic",
                 font.y = c(12, "bold", "black"),   ## can be "red", "darked"
                 font.tickslab = c(12, "bold", "black"),
                 break.time.by=2,
                 xlim=c(0, 10),
                 pval=TRUE,
                 ylim=c(0,100),
                 pval.coord = c(0.2, 1.5),
                 pval.size = 4.5,
                 title="  ",
                 tables.theme=theme_cleantable(),
                 axes.offset=TRUE,
                 tables.y.text=FALSE)
os$plot <- os$plot + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                           plot.title= element_text(hjust=.5),
                           axis.text = element_text( color="black", size = 12, face="bold"))+
  theme(#legend.position="right",
    legend.title = element_text(colour="black", size=12,  face="bold") ,
    legend.text = element_text(colour="black", size=12,  face="bold"))
os$table <- os$table +
  theme(plot.title = element_text(size = 12, color = "black", face = "bold", hjust = -0.25),
        plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
        legend.text = element_text(colour="black", size=12,  face="bold"))
print(os)
}

# 9.	PD-L1--------------------------------------------------------------------------

fun_survcurvePD_L1 <- function(dat) {

library(survival)
library(survminer)
os_fit <- survfit(Surv(time=RFS_years , event=RFS_c) ~ PD_L1_  , data=dat)
os <- ggsurvplot(os_fit,
                 fun=function(y) y*100,
                 #fun = function(x) {1 - x},
                 xlab="RFS_years",
                 ylab="Estimated Survival Probability (%)",
                 linetype = c(1, 1, 1),
                 palette=c("red", "blue", "black"),
                 legend.title="",
                 legend = c(0.14,0.23),
                 legend.labs=c( "PD-L1_low", "PD-L1_mid", "PD-L1_high"),
                 font.legend = c(10, "bold", "black"),
                 censor = FALSE,
                 risk.table = TRUE,
                 risk.table.title = "                                      Number at Risk",
                 risk.table.fontsize = 4.5,
                 risk.table.height =.15,
                 font.x = c(12, "bold", "black"),  ## can be "bold.italic",
                 font.y = c(12, "bold", "black"),   ## can be "red", "darked"
                 font.tickslab = c(12, "bold", "black"),
                 break.time.by=2,
                 xlim=c(0, 10),
                 pval=TRUE,
                 ylim=c(0,100),
                 pval.coord = c(0.2, 1.5),
                 pval.size = 4.5,
                 title="  ",
                 tables.theme=theme_cleantable(),
                 axes.offset=TRUE,
                 tables.y.text=FALSE)
os$plot <- os$plot + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                           plot.title= element_text(hjust=.5),
                           axis.text = element_text( color="black", size = 12, face="bold"))+
  theme(#legend.position="right",
    legend.title = element_text(colour="black", size=12,  face="bold") ,
    legend.text = element_text(colour="black", size=12,  face="bold"))
os$table <- os$table +
  theme(plot.title = element_text(size = 12, color = "black", face = "bold", hjust = -0.25),
        plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
        legend.text = element_text(colour="black", size=12,  face="bold"))
print(os)
}



# 10.	PD-L2--------------------------------------------------------------------------

fun_survcurvePD_L2 <- function(dat) {

library(survival)
library(survminer)
os_fit <- survfit(Surv(time=RFS_years , event=RFS_c) ~ PD_L2_  , data=dat)
os <- ggsurvplot(os_fit,
                 fun=function(y) y*100,
                 #fun = function(x) {1 - x},
                 xlab="RFS_years",
                 ylab="Estimated Survival Probability (%)",
                 linetype = c(1, 1, 1),
                 palette=c("red", "blue", "black"),
                 legend.title="",
                 legend = c(0.14,0.23),
                 legend.labs=c( "PD-L2_low", "PD-L2_mid", "PD-L2_high"),
                 font.legend = c(10, "bold", "black"),
                 censor = FALSE,
                 risk.table = TRUE,
                 risk.table.title = "                                      Number at Risk",
                 risk.table.fontsize = 4.5,
                 risk.table.height =.15,
                 font.x = c(12, "bold", "black"),  ## can be "bold.italic",
                 font.y = c(12, "bold", "black"),   ## can be "red", "darked"
                 font.tickslab = c(12, "bold", "black"),
                 break.time.by=2,
                 xlim=c(0, 10),
                 pval=TRUE,
                 ylim=c(0,100),
                 pval.coord = c(0.2, 1.5),
                 pval.size = 4.5,
                 title="  ",
                 tables.theme=theme_cleantable(),
                 axes.offset=TRUE,
                 tables.y.text=FALSE)
os$plot <- os$plot + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                           plot.title= element_text(hjust=.5),
                           axis.text = element_text( color="black", size = 12, face="bold"))+
  theme(#legend.position="right",
    legend.title = element_text(colour="black", size=12,  face="bold") ,
    legend.text = element_text(colour="black", size=12,  face="bold"))
os$table <- os$table +
  theme(plot.title = element_text(size = 12, color = "black", face = "bold", hjust = -0.25),
        plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
        legend.text = element_text(colour="black", size=12,  face="bold"))
print(os)
}



# 11.	 CD20--------------------------------------------------------------------------
fun_survcurveCD20 <- function(dat) {
library(survival)
library(survminer)
os_fit <- survfit(Surv(time=RFS_years , event=RFS_c) ~ CD20_  , data=dat) ## do not use dat <- as.data.frame(dat),otherwise wrong

os <- ggsurvplot(os_fit,  fun=function(y) y*100,  xlab="RFS_years",   ylab="Estimated Survival Probability (%)",
                 linetype = c(1, 1, 1), palette=c("red", "blue", "black"), legend.title="",  legend = c(0.14,0.23),
                 legend.labs=c( "CD20_low", "CD20_mid", "CD20_high"), font.legend = c(10, "bold", "black"),
                 censor = FALSE,  risk.table = TRUE,
                 risk.table.title = "                                      Number at Risk",
                 risk.table.fontsize = 4.5, risk.table.height =.15,
                 font.x = c(12, "bold", "black"),  font.y = c(12, "bold", "black"),   ## can be "red", "darked" ## can be "bold.italic"
                 font.tickslab = c(12, "bold", "black"), break.time.by=2, xlim=c(0, 10),  ylim=c(0,100), pval=TRUE,
                 pval.coord = c(0.2, 1.5),  pval.size = 4.5, title="  ",
                 tables.theme=theme_cleantable(), axes.offset=TRUE, tables.y.text=FALSE)

os$plot <- os$plot + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                           plot.title= element_text(hjust=.5,color="black", size = 12, face="bold"),
                           axis.text = element_text( color="black", size = 12, face="bold"),
                           legend.title = element_text(colour="black", size=12,  face="bold") ,
                           legend.text = element_text(colour="black", size=12,  face="bold"))    # chenge high low
             #  annotate("text", x = 10, y = 15, label = "P-value",  vjust=0, hjust = 1.1, face = "bold", fontface=16)  ## add some the figure
             #  legend.position="right",
os$table <- os$table + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                   plot.title = element_text(size = 12, color = "black", face = "bold", hjust = -0.25), 
                   legend.text = element_text(colour="black", size=12,  face="bold"))
print(os)
}

# 12.	CD3--------------------------------------------------------------------------
fun_survcurveCD3 <- function(dat) {
library(survival)
library(survminer)
os_fit <- survfit(Surv(time=RFS_years , event=RFS_c) ~ CD3_  , data=dat) ## do not use dat <- as.data.frame(dat),otherwise wrong

os <- ggsurvplot(os_fit,  fun=function(y) y*100,  xlab="RFS_years",   ylab="Estimated Survival Probability (%)",
                 linetype = c(1, 1, 1), palette=c("red", "blue", "black"), legend.title="",  legend = c(0.12,0.23),
                 legend.labs=c( "CD3_low", "CD3_mid", "CD3_high"), font.legend = c(10, "bold", "black"),
                 censor = FALSE,  risk.table = TRUE,
                 risk.table.title = "                                      Number at Risk",
                 risk.table.fontsize = 4.5, risk.table.height =.15,
                 font.x = c(12, "bold", "black"),  font.y = c(12, "bold", "black"),   ## can be "red", "darked" ## can be "bold.italic"
                 font.tickslab = c(12, "bold", "black"), break.time.by=2, xlim=c(0, 10),  ylim=c(0,100), pval=TRUE,
                 pval.coord = c(0.2, 1.5),  pval.size = 4.5, title="  ",
                 tables.theme=theme_cleantable(), axes.offset=TRUE, tables.y.text=FALSE)

os$plot <- os$plot + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                           plot.title= element_text(hjust=.5,color="black", size = 12, face="bold"),
                           axis.text = element_text( color="black", size = 12, face="bold"),
                           legend.title = element_text(colour="black", size=12,  face="bold") ,
                           legend.text = element_text(colour="black", size=12,  face="bold"))    # chenge high low
             #  annotate("text", x = 10, y = 15, label = "P-value",  vjust=0, hjust = 1.1, face = "bold", fontface=16)  ## add some the figure
             #  legend.position="right",
os$table <- os$table + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                   plot.title = element_text(size = 12, color = "black", face = "bold", hjust = -0.25), 
                   legend.text = element_text(colour="black", size=12,  face="bold"))
print(os)
}



```



```{r echo = FALSE,  warning=FALSE, message=FALSE}

# 13.	CD4 --------------------------------------------------------------------------
fun_survcurveCD4 <- function(dat) {
library(survival)
library(survminer)
os_fit <- survfit(Surv(time=RFS_years , event=RFS_c) ~ CD4_  , data=dat) ## do not use dat <- as.data.frame(dat),otherwise wrong

os <- ggsurvplot(os_fit,  fun=function(y) y*100,  xlab="RFS_years",   ylab="Estimated Survival Probability (%)",
                 linetype = c(1, 1, 1), palette=c("red", "blue", "black"), legend.title="",  legend = c(0.11,0.23),
                 legend.labs=c( "CD4_low", "CD4_mid", "CD4_high"), font.legend = c(10, "bold", "black"),
                 censor = FALSE,  risk.table = TRUE,
                 risk.table.title = "                                      Number at Risk",
                 risk.table.fontsize = 4.5, risk.table.height =.15,
                 font.x = c(12, "bold", "black"),  font.y = c(12, "bold", "black"),   ## can be "red", "darked" ## can be "bold.italic"
                 font.tickslab = c(12, "bold", "black"), break.time.by=2, xlim=c(0, 10),  ylim=c(0,100), pval=TRUE,
                 pval.coord = c(0.2, 1.5),  pval.size = 4.5, title="  ",
                 tables.theme=theme_cleantable(), axes.offset=TRUE, tables.y.text=FALSE)

os$plot <- os$plot + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                           plot.title= element_text(hjust=.5,color="black", size = 12, face="bold"),
                           axis.text = element_text( color="black", size = 12, face="bold"),
                           legend.title = element_text(colour="black", size=12,  face="bold") ,
                           legend.text = element_text(colour="black", size=12,  face="bold"))    # chenge high low
             #  annotate("text", x = 10, y = 15, label = "P-value",  vjust=0, hjust = 1.1, face = "bold", fontface=16)  ## add some the figure
             #  legend.position="right",
os$table <- os$table + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                   plot.title = element_text(size = 12, color = "black", face = "bold", hjust = -0.25), 
                   legend.text = element_text(colour="black", size=12,  face="bold"))
print(os)
}
# 14.	CTLA4--------------------------------------------------------------------------

fun_survcurveCTLA4 <- function(dat) {
library(survival)
library(survminer)
os_fit <- survfit(Surv(time=RFS_years , event=RFS_c) ~ CTLA4_  , data=dat) ## do not use dat <- as.data.frame(dat),otherwise wrong

os <- ggsurvplot(os_fit,  fun=function(y) y*100,  xlab="RFS_years",   ylab="Estimated Survival Probability (%)",
                 linetype = c(1, 1, 1), palette=c("red", "blue", "black"), legend.title="",  legend = c(0.14,0.23),
                 legend.labs=c( "CTLA4_low", "CTLA4_mid", "CTLA4_high"), font.legend = c(10, "bold", "black"),
                 censor = FALSE,  risk.table = TRUE,
                 risk.table.title = "                                      Number at Risk",
                 risk.table.fontsize = 4.5, risk.table.height =.15,
                 font.x = c(12, "bold", "black"),  font.y = c(12, "bold", "black"),   ## can be "red", "darked" ## can be "bold.italic"
                 font.tickslab = c(12, "bold", "black"), break.time.by=2, xlim=c(0, 10),  ylim=c(0,100), pval=TRUE,
                 pval.coord = c(0.2, 1.5),  pval.size = 4.5, title="  ",
                 tables.theme=theme_cleantable(), axes.offset=TRUE, tables.y.text=FALSE)

os$plot <- os$plot + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                           plot.title= element_text(hjust=.5,color="black", size = 12, face="bold"),
                           axis.text = element_text( color="black", size = 12, face="bold"),
                           legend.title = element_text(colour="black", size=12,  face="bold") ,
                           legend.text = element_text(colour="black", size=12,  face="bold"))    # chenge high low
             #  annotate("text", x = 10, y = 15, label = "P-value",  vjust=0, hjust = 1.1, face = "bold", fontface=16)  ## add some the figure
             #  legend.position="right",
os$table <- os$table + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                   plot.title = element_text(size = 12, color = "black", face = "bold", hjust = -0.25), 
                   legend.text = element_text(colour="black", size=12,  face="bold"))
print(os)
}
# 15.	SMA--------------------------------------------------------------------------
fun_survcurveSMA <- function(dat) {
library(survival)
library(survminer)
os_fit <- survfit(Surv(time=RFS_years , event=RFS_c) ~ SMA_  , data=dat) ## do not use dat <- as.data.frame(dat),otherwise wrong

os <- ggsurvplot(os_fit,  fun=function(y) y*100,  xlab="RFS_years",   ylab="Estimated Survival Probability (%)",
                 linetype = c(1, 1, 1), palette=c("red", "blue", "black"), legend.title="",  legend = c(0.11,0.23),
                 legend.labs=c( "SMA_low", "SMA_mid", "SMA_high"), font.legend = c(10, "bold", "black"),
                 censor = FALSE,  risk.table = TRUE,
                 risk.table.title = "                                      Number at Risk",
                 risk.table.fontsize = 4.5, risk.table.height =.15,
                 font.x = c(12, "bold", "black"),  font.y = c(12, "bold", "black"),   ## can be "red", "darked" ## can be "bold.italic"
                 font.tickslab = c(12, "bold", "black"), break.time.by=2, xlim=c(0, 10),  ylim=c(0,100), pval=TRUE,
                 pval.coord = c(0.2, 1.5),  pval.size = 4.5, title="  ",
                 tables.theme=theme_cleantable(), axes.offset=TRUE, tables.y.text=FALSE)

os$plot <- os$plot + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                           plot.title= element_text(hjust=.5,color="black", size = 12, face="bold"),
                           axis.text = element_text( color="black", size = 12, face="bold"),
                           legend.title = element_text(colour="black", size=12,  face="bold") ,
                           legend.text = element_text(colour="black", size=12,  face="bold"))    # chenge high low
             #  annotate("text", x = 10, y = 15, label = "P-value",  vjust=0, hjust = 1.1, face = "bold", fontface=16)  ## add some the figure
             #  legend.position="right",
os$table <- os$table + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                   plot.title = element_text(size = 12, color = "black", face = "bold", hjust = -0.25), 
                   legend.text = element_text(colour="black", size=12,  face="bold"))
print(os)
}
# 16.	CD45--------------------------------------------------------------------------
fun_survcurveCD45 <- function(dat) {
library(survival)
library(survminer)
os_fit <- survfit(Surv(time=RFS_years , event=RFS_c) ~ CD45_  , data=dat) ## do not use dat <- as.data.frame(dat),otherwise wrong

os <- ggsurvplot(os_fit,  fun=function(y) y*100,  xlab="RFS_years",   ylab="Estimated Survival Probability (%)",
                 linetype = c(1, 1, 1), palette=c("red", "blue", "black"), legend.title="",  legend = c(0.14,0.23),
                 legend.labs=c( "CD45_low", "CD45_mid", "CD45_high"), font.legend = c(10, "bold", "black"),
                 censor = FALSE,  risk.table = TRUE,
                 risk.table.title = "                                      Number at Risk",
                 risk.table.fontsize = 4.5, risk.table.height =.15,
                 font.x = c(12, "bold", "black"),  font.y = c(12, "bold", "black"),   ## can be "red", "darked" ## can be "bold.italic"
                 font.tickslab = c(12, "bold", "black"), break.time.by=2, xlim=c(0, 10),  ylim=c(0,100), pval=TRUE,
                 pval.coord = c(0.2, 1.5),  pval.size = 4.5, title="  ",
                 tables.theme=theme_cleantable(), axes.offset=TRUE, tables.y.text=FALSE)

os$plot <- os$plot + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                           plot.title= element_text(hjust=.5,color="black", size = 12, face="bold"),
                           axis.text = element_text( color="black", size = 12, face="bold"),
                           legend.title = element_text(colour="black", size=12,  face="bold") ,
                           legend.text = element_text(colour="black", size=12,  face="bold"))    # chenge high low
             #  annotate("text", x = 10, y = 15, label = "P-value",  vjust=0, hjust = 1.1, face = "bold", fontface=16)  ## add some the figure
             #  legend.position="right",
os$table <- os$table + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                   plot.title = element_text(size = 12, color = "black", face = "bold", hjust = -0.25), 
                   legend.text = element_text(colour="black", size=12,  face="bold"))
print(os)
}
# 17.	ICOS--------------------------------------------------------------------------
fun_survcurveICOS <- function(dat) {
library(survival)
library(survminer)
os_fit <- survfit(Surv(time=RFS_years , event=RFS_c) ~ ICOS_  , data=dat) ## do not use dat <- as.data.frame(dat),otherwise wrong

os <- ggsurvplot(os_fit,  fun=function(y) y*100,  xlab="RFS_years",   ylab="Estimated Survival Probability (%)",
                 linetype = c(1, 1, 1), palette=c("red", "blue", "black"), legend.title="",  legend = c(0.14,0.23),
                 legend.labs=c( "ICOS_low", "ICOS_mid", "ICOS_high"), font.legend = c(10, "bold", "black"),
                 censor = FALSE,  risk.table = TRUE,
                 risk.table.title = "                                      Number at Risk",
                 risk.table.fontsize = 4.5, risk.table.height =.15,
                 font.x = c(12, "bold", "black"),  font.y = c(12, "bold", "black"),   ## can be "red", "darked" ## can be "bold.italic"
                 font.tickslab = c(12, "bold", "black"), break.time.by=2, xlim=c(0, 10),  ylim=c(0,100), pval=TRUE,
                 pval.coord = c(0.22, 1.5),  pval.size = 4.5, title="  ",
                 tables.theme=theme_cleantable(), axes.offset=TRUE, tables.y.text=FALSE)

os$plot <- os$plot + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                           plot.title= element_text(hjust=.5,color="black", size = 12, face="bold"),
                           axis.text = element_text( color="black", size = 12, face="bold"),
                           legend.title = element_text(colour="black", size=12,  face="bold") ,
                           legend.text = element_text(colour="black", size=12,  face="bold"))    # chenge high low
             #  annotate("text", x = 10, y = 15, label = "P-value",  vjust=0, hjust = 1.1, face = "bold", fontface=16)  ## add some the figure
             #  legend.position="right",
os$table <- os$table + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                   plot.title = element_text(size = 12, color = "black", face = "bold", hjust = -0.25), 
                   legend.text = element_text(colour="black", size=12,  face="bold"))
print(os)
}
# 18.	FN (Fibronectin)---------------------------------------------------------------------

fun_survcurveFibronectin <- function(dat) {
library(survival)
library(survminer)
os_fit <- survfit(Surv(time=RFS_years , event=RFS_c) ~ Fibronectin_  , data=dat) ## do not use dat <- as.data.frame(dat),otherwise wrong

os <- ggsurvplot(os_fit,  fun=function(y) y*100,  xlab="RFS_years",   ylab="Estimated Survival Probability (%)",
                 linetype = c(1, 1, 1), palette=c("red", "blue", "black"), legend.title="",  legend = c(0.11,0.23),
                 legend.labs=c( "FN_low", "FN_mid", "FN_high"), font.legend = c(10, "bold", "black"),
                 censor = FALSE,  risk.table = TRUE,
                 risk.table.title = "                                      Number at Risk",
                 risk.table.fontsize = 4.5, risk.table.height =.15,
                 font.x = c(12, "bold", "black"),  font.y = c(12, "bold", "black"),   ## can be "red", "darked" ## can be "bold.italic"
                 font.tickslab = c(12, "bold", "black"), break.time.by=2, xlim=c(0, 10),  ylim=c(0,100), pval=TRUE,
                 pval.coord = c(0.2, 1.5),  pval.size = 4.5, title="  ",
                 tables.theme=theme_cleantable(), axes.offset=TRUE, tables.y.text=FALSE)

os$plot <- os$plot + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                           plot.title= element_text(hjust=.5,color="black", size = 12, face="bold"),
                           axis.text = element_text( color="black", size = 12, face="bold"),
                           legend.title = element_text(colour="black", size=12,  face="bold") ,
                           legend.text = element_text(colour="black", size=12,  face="bold"))    # chenge high low
             #  annotate("text", x = 10, y = 15, label = "P-value",  vjust=0, hjust = 1.1, face = "bold", fontface=16)  ## add some the figure
             #  legend.position="right",
os$table <- os$table + theme(plot.margin = unit(c(5.5, 5.5, 5.5, 50), "points"),
                   plot.title = element_text(size = 12, color = "black", face = "bold", hjust = -0.25), 
                   legend.text = element_text(colour="black", size=12,  face="bold"))
print(os)
}


```

<!-- 1.	 HLA-DR -->
## Figure 1-1: Survival curve for RFS by HLA_DR levels based on tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat1
fun_survcurveHLA_DR(dat)

```

## Figure 1-2: Survival curve for RFS by HLA_DR levels based on stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat2
fun_survcurveHLA_DR(dat)


```

## Figure 1-3: Survival curve for RFS by HLA_DR levels based on CD45tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat3
fun_survcurveHLA_DR(dat)


```

## Figure 1-4: Survival curve for RFS by HLA_DR levels based on CD68tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat4
fun_survcurveHLA_DR(dat)

```

## Figure 1-5: Survival curve for RFS by HLA_DR levels based on tumortumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat5
fun_survcurveHLA_DR(dat)

```

## Figure 1-6: Survival curve for RFS by HLA_DR levels based on CD45stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}

dat <- dat6
fun_survcurveHLA_DR(dat)

```

## Figure 1-7: Survival curve for RFS by HLA_DR levels based on CD68stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat7
fun_survcurveHLA_DR(dat)

```

## Figure 1-8: Survival curve for RFS by HLA_DR levels based on all segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat8
fun_survcurveHLA_DR(dat)

```



<!-- 2.	IDO-1 -->


## Figure 2-1: Survival curve for RFS by IDO1 levels based on tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat1
fun_survcurveIDO1(dat)

```

## Figure 2-2: Survival curve for RFS by IDO1 levels based on stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat2
fun_survcurveIDO1(dat)


```

## Figure 2-3: Survival curve for RFS by IDO1 levels based on CD45tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat3
fun_survcurveIDO1(dat)


```

## Figure 2-4: Survival curve for RFS by IDO1 levels based on CD68tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat4
fun_survcurveIDO1(dat)

```

## Figure 2-5: Survival curve for RFS by IDO1 levels based on tumortumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat5
fun_survcurveIDO1(dat)

```

## Figure 2-6: Survival curve for RFS by IDO1 levels based on CD45stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}

dat <- dat6
fun_survcurveIDO1(dat)

```

## Figure 2-7: Survival curve for RFS by IDO1 levels based on CD68stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat7
fun_survcurveIDO1(dat)

```

## Figure 2-8: Survival curve for RFS by IDO1 levels based on all segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat8
fun_survcurveIDO1(dat)

```


<!--3.	CD27 -->

## Figure 3-1: Survival curve for RFS by CD27 levels based on tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat1
fun_survcurveCD27(dat)

```

## Figure 3-2: Survival curve for RFS by CD27 levels based on stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat2
fun_survcurveCD27(dat)


```

## Figure 3-3: Survival curve for RFS by CD27 levels based on CD45tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat3
fun_survcurveCD27(dat)


```

## Figure 3-4: Survival curve for RFS by CD27 levels based on CD68tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat4
fun_survcurveCD27(dat)

```

## Figure 3-5: Survival curve for RFS by CD27 levels based on tumortumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat5
fun_survcurveCD27(dat)

```

## Figure 3-6: Survival curve for RFS by CD27 levels based on CD45stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}

dat <- dat6
fun_survcurveCD27(dat)

```

## Figure 3-7: Survival curve for RFS by CD27 levels based on CD68stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat7
fun_survcurveCD27(dat)

```

## Figure 3-8: Survival curve for RFS by CD27 levels based on all segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat8
fun_survcurveCD27(dat)

```

<!-- 4.	CD40 -->


## Figure 4-1: Survival curve for RFS by CD40 levels based on tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat1
fun_survcurveCD40(dat)

```

## Figure 4-2: Survival curve for RFS by CD40 levels based on stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat2
fun_survcurveCD40(dat)


```

## Figure 4-3: Survival curve for RFS by CD40 levels based on CD45tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat3
fun_survcurveCD40(dat)


```

## Figure 4-4: Survival curve for RFS by CD40 levels based on CD68tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat4
fun_survcurveCD40(dat)

```

## Figure 4-5: Survival curve for RFS by CD40 levels based on tumortumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat5
fun_survcurveCD40(dat)

```

## Figure 4-6: Survival curve for RFS by CD40 levels based on CD45stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}

dat <- dat6
fun_survcurveCD40(dat)

```

## Figure 4-7: Survival curve for RFS by CD40 levels based on CD68stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat7
fun_survcurveCD40(dat)

```

## Figure 4-8: Survival curve for RFS by CD40 levels based on all segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat8
fun_survcurveCD40(dat)

```

<!-- 5.	CD56 -->

## Figure 5-1: Survival curve for RFS by CD56 levels based on tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat1
fun_survcurveCD56(dat)

```

## Figure 5-2: Survival curve for RFS by CD56 levels based on stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat2
fun_survcurveCD56(dat)


```

## Figure 5-3: Survival curve for RFS by CD56 levels based on CD45tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat3
fun_survcurveCD56(dat)


```

## Figure 5-4: Survival curve for RFS by CD56 levels based on CD68tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat4
fun_survcurveCD56(dat)

```

## Figure 5-5: Survival curve for RFS by CD56 levels based on tumortumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat5
fun_survcurveCD56(dat)

```

## Figure 5-6: Survival curve for RFS by CD56 levels based on CD45stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}

dat <- dat6
fun_survcurveCD56(dat)

```

## Figure 5-7: Survival curve for RFS by CD56 levels based on CD68stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat7
fun_survcurveCD56(dat)

```

## Figure 5-8: Survival curve for RFS by CD56 levels based on all segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat8
fun_survcurveCD56(dat)

```

<!-- 7.	CD11c.        6 -->


## Figure 6-1: Survival curve for RFS by CD11c levels based on tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat1
fun_survcurveCD11c(dat)

```

## Figure 6-2: Survival curve for RFS by CD11c levels based on stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat2
fun_survcurveCD11c(dat)


```

## Figure 6-3: Survival curve for RFS by CD11c levels based on CD45tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat3
fun_survcurveCD11c(dat)


```

## Figure 6-4: Survival curve for RFS by CD11c levels based on CD68tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat4
fun_survcurveCD11c(dat)

```

## Figure 6-5: Survival curve for RFS by CD11c levels based on tumortumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat5
fun_survcurveCD11c(dat)

```

## Figure 6-6: Survival curve for RFS by CD11c levels based on CD45stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}

dat <- dat6
fun_survcurveCD11c(dat)

```

## Figure 6-7: Survival curve for RFS by CD11c levels based on CD68stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat7
fun_survcurveCD11c(dat)

```

## Figure 6-8: Survival curve for RFS by CD11c levels based on all segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat8
fun_survcurveCD11c(dat)

```

<!-- 8.	GZMB    7-->


## Figure 7-1: Survival curve for RFS by GZMB levels based on tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat1
fun_survcurveGZMB(dat)

```

## Figure 7-2: Survival curve for RFS by GZMB levels based on stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat2
fun_survcurveGZMB(dat)


```

## Figure 7-3: Survival curve for RFS by GZMB levels based on CD45tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat3
fun_survcurveGZMB(dat)


```

## Figure 7-4: Survival curve for RFS by GZMB levels based on CD68tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat4
fun_survcurveGZMB(dat)

```

## Figure 7-5: Survival curve for RFS by GZMB levels based on tumortumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat5
fun_survcurveGZMB(dat)

```

## Figure 7-6: Survival curve for RFS by GZMB levels based on CD45stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}

dat <- dat6
fun_survcurveGZMB(dat)

```

## Figure 7-7: Survival curve for RFS by GZMB levels based on CD68stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat7
fun_survcurveGZMB(dat)

```

## Figure 7-8: Survival curve for RFS by GZMB levels based on all segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat8
fun_survcurveGZMB(dat)

```

<!-- 9.	PD-L1    8-->


## Figure 8-1: Survival curve for RFS by PD-L1 levels based on tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat1
fun_survcurvePD_L1(dat)

```

## Figure 8-2: Survival curve for RFS by PD-L1 levels based on stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat2
fun_survcurvePD_L1(dat)


```

## Figure 8-3: Survival curve for RFS by PD-L1 levels based on CD45tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat3
fun_survcurvePD_L1(dat)


```

## Figure 8-4: Survival curve for RFS by PD-L1 levels based on CD68tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat4
fun_survcurvePD_L1(dat)

```

## Figure 8-5: Survival curve for RFS by PD-L1 levels based on tumortumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat5
fun_survcurvePD_L1(dat)

```

## Figure 8-6: Survival curve for RFS by PD-L1 levels based on CD45stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}

dat <- dat6
fun_survcurvePD_L1(dat)

```

## Figure 8-7: Survival curve for RFS by PD-L1 levels based on CD68stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat7
fun_survcurvePD_L1(dat)

```

## Figure 8-8: Survival curve for RFS by PD-L1 levels based on all segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat8
fun_survcurvePD_L1(dat)

```

<!-- 10.	PD-L2    9 -->


## Figure 9-1: Survival curve for RFS by PD-L2  levels based on tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat1
fun_survcurvePD_L2(dat)

```

## Figure 9-2: Survival curve for RFS by PD-L2  levels based on stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat2
fun_survcurvePD_L2(dat)


```

## Figure 9-3: Survival curve for RFS by PD-L2  levels based on CD45tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat3
fun_survcurvePD_L2(dat)


```

## Figure 9-4: Survival curve for RFS by PD-L2  levels based on CD68tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat4
fun_survcurvePD_L2(dat)

```

## Figure 9-5: Survival curve for RFS by PD-L2  levels based on tumortumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat5
fun_survcurvePD_L2(dat)

```

## Figure 9-6: Survival curve for RFS by PD-L2  levels based on CD45stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}

dat <- dat6
fun_survcurvePD_L2(dat)

```

## Figure 9-7: Survival curve for RFS by PD-L2  levels based on CD68stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat7
fun_survcurvePD_L2(dat)

```

## Figure 9-8: Survival curve for RFS by PD-L2  levels based on all segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat8
fun_survcurvePD_L2(dat)

```

<!-- 11.	 CD20     10-->

## Figure 10-1: Survival curve for RFS by CD20 levels based on tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat1
fun_survcurveCD20(dat)

```

## Figure 10-2: Survival curve for RFS by CD20 levels based on stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat2
fun_survcurveCD20(dat)


```

## Figure 10-3: Survival curve for RFS by CD20 levels based on CD45tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat3
fun_survcurveCD20(dat)


```

## Figure 10-4: Survival curve for RFS by CD20 levels based on CD68tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat4
fun_survcurveCD20(dat)

```

## Figure 10-5: Survival curve for RFS by CD20 levels based on tumortumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat5
fun_survcurveCD20(dat)

```

## Figure 10-6: Survival curve for RFS by CD20 levels based on CD45stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}

dat <- dat6
fun_survcurveCD20(dat)

```

## Figure 10-7: Survival curve for RFS by CD20 levels based on CD68stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat7
fun_survcurveCD20(dat)

```

## Figure 10-8: Survival curve for RFS by CD20 levels based on all segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat8
fun_survcurveCD20(dat)

```

<!-- 12.	CD3    11-->


## Figure 11-1: Survival curve for RFS by CD3 levels based on tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat1
fun_survcurveCD3(dat)

```

## Figure 11-2: Survival curve for RFS by CD3 levels based on stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat2
fun_survcurveCD3(dat)


```

## Figure 11-3: Survival curve for RFS by CD3 levels based on CD45tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat3
fun_survcurveCD3(dat)


```

## Figure 11-4: Survival curve for RFS by CD3 levels based on CD68tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat4
fun_survcurveCD3(dat)

```

## Figure 11-5: Survival curve for RFS by CD3 levels based on tumortumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat5
fun_survcurveCD3(dat)

```

## Figure 11-6: Survival curve for RFS by CD3 levels based on CD45stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}

dat <- dat6
fun_survcurveCD3(dat)

```

## Figure 11-7: Survival curve for RFS by CD3 levels based on CD68stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat7
fun_survcurveCD3(dat)

```

## Figure 11-8: Survival curve for RFS by CD3 levels based on all segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat8
fun_survcurveCD3(dat)

```

<!-- 13.	CD4     12-->

## Figure 12-1: Survival curve for RFS by CD4 levels based on tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat1
fun_survcurveCD4(dat)

```

## Figure 12-2: Survival curve for RFS by CD4 levels based on stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat2
fun_survcurveCD4(dat)


```

## Figure 12-3: Survival curve for RFS by CD4 levels based on CD45tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat3
fun_survcurveCD4(dat)


```

## Figure 12-4: Survival curve for RFS by CD4 levels based on CD68tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat4
fun_survcurveCD4(dat)

```

## Figure 12-5: Survival curve for RFS by CD4 levels based on tumortumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat5
fun_survcurveCD4(dat)

```

## Figure 12-6: Survival curve for RFS by CD4 levels based on CD45stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}

dat <- dat6
fun_survcurveCD4(dat)

```

## Figure 12-7: Survival curve for RFS by CD4 levels based on CD68stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat7
fun_survcurveCD4(dat)

```

## Figure 12-8: Survival curve for RFS by CD4 levels based on all segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat8
fun_survcurveCD4(dat)

```

<!-- 14.	CTLA4    13  -->


## Figure 13-1: Survival curve for RFS by CTLA4 levels based on tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat1
fun_survcurveCTLA4(dat)

```

## Figure 13-2: Survival curve for RFS by CTLA4 levels based on stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat2
fun_survcurveCTLA4(dat)


```

## Figure 13-3: Survival curve for RFS by CTLA4 levels based on CD45tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat3
fun_survcurveCTLA4(dat)


```

## Figure 13-4: Survival curve for RFS by CTLA4 levels based on CD68tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat4
fun_survcurveCTLA4(dat)

```

## Figure 13-5: Survival curve for RFS by CTLA4 levels based on tumortumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat5
fun_survcurveCTLA4(dat)

```

## Figure 13-6: Survival curve for RFS by CTLA4 levels based on CD45stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}

dat <- dat6
fun_survcurveCTLA4(dat)

```

## Figure 13-7: Survival curve for RFS by CTLA4 levels based on CD68stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat7
fun_survcurveCTLA4(dat)

```

## Figure 13-8: Survival curve for RFS by CTLA4 levels based on all segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat8
fun_survcurveCTLA4(dat)

```

<!-- 15.	SMA   14  -->


## Figure 14-1: Survival curve for RFS by SMA levels based on tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat1
fun_survcurveSMA(dat)

```

## Figure 14-2: Survival curve for RFS by SMA levels based on stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat2
fun_survcurveSMA(dat)


```

## Figure 14-3: Survival curve for RFS by SMA levels based on CD45tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat3
fun_survcurveSMA(dat)


```

## Figure 14-4: Survival curve for RFS by SMA levels based on CD68tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat4
fun_survcurveSMA(dat)

```

## Figure 14-5: Survival curve for RFS by SMA levels based on tumortumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat5
fun_survcurveSMA(dat)

```

## Figure 14-6: Survival curve for RFS by SMA levels based on CD45stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}

dat <- dat6
fun_survcurveSMA(dat)

```

## Figure 14-7: Survival curve for RFS by SMA levels based on CD68stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat7
fun_survcurveSMA(dat)

```

## Figure 14-8: Survival curve for RFS by SMA levels based on all segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat8
fun_survcurveSMA(dat)

```

<!-- 16.	CD45   15 -->


## Figure 15-1: Survival curve for RFS by CD45 levels based on tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat1
fun_survcurveCD45(dat)

```

## Figure 15-2: Survival curve for RFS by CD45 levels based on stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat2
fun_survcurveCD45(dat)


```

## Figure 15-3: Survival curve for RFS by CD45 levels based on CD45tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat3
fun_survcurveCD45(dat)


```

## Figure 15-4: Survival curve for RFS by CD45 levels based on CD68tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat4
fun_survcurveCD45(dat)

```

## Figure 15-5: Survival curve for RFS by CD45 levels based on tumortumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat5
fun_survcurveCD45(dat)

```

## Figure 15-6: Survival curve for RFS by CD45 levels based on CD45stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}

dat <- dat6
fun_survcurveCD45(dat)

```

## Figure 15-7: Survival curve for RFS by CD45 levels based on CD68stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat7
fun_survcurveCD45(dat)

```

## Figure 15-8: Survival curve for RFS by CD45 levels based on all segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat8
fun_survcurveCD45(dat)

```

<!-- 17.	ICOS   16 -->


## Figure 16-1: Survival curve for RFS by ICOS levels based on tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat1
fun_survcurveICOS(dat)

```

## Figure 16-2: Survival curve for RFS by ICOS levels based on stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat2
fun_survcurveICOS(dat)


```

## Figure 16-3: Survival curve for RFS by ICOS levels based on CD45tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat3
fun_survcurveICOS(dat)


```

## Figure 16-4: Survival curve for RFS by ICOS levels based on CD68tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat4
fun_survcurveICOS(dat)

```

## Figure 16-5: Survival curve for RFS by ICOS levels based on tumortumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat5
fun_survcurveICOS(dat)

```

## Figure 16-6: Survival curve for RFS by ICOS levels based on CD45stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}

dat <- dat6
fun_survcurveICOS(dat)

```

## Figure 16-7: Survival curve for RFS by ICOS levels based on CD68stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat7
fun_survcurveICOS(dat)

```

## Figure 16-8: Survival curve for RFS by ICOS levels based on all segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat8
fun_survcurveICOS(dat)

```

<!-- 18.	FN (Fibronectin)   17-->

## Figure 17-1: Survival curve for RFS by Fibronectin levels based on tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat1
fun_survcurveFibronectin(dat)

```

## Figure 17-2: Survival curve for RFS by Fibronectin levels based on stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat2
fun_survcurveFibronectin(dat)


```

## Figure 17-3: Survival curve for RFS by Fibronectin levels based on CD45tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat3
fun_survcurveFibronectin(dat)


```

## Figure 17-4: Survival curve for RFS by Fibronectin levels based on CD68tumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat4
fun_survcurveFibronectin(dat)

```

## Figure 17-5: Survival curve for RFS by Fibronectin levels based on tumortumor segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat5
fun_survcurveFibronectin(dat)

```

## Figure 17-6: Survival curve for RFS by Fibronectin levels based on CD45stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}

dat <- dat6
fun_survcurveFibronectin(dat)

```

## Figure 17-7: Survival curve for RFS by Fibronectin levels based on CD68stroma segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat7
fun_survcurveFibronectin(dat)

```

## Figure 17-8: Survival curve for RFS by Fibronectin levels based on all segments.

```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
dat <- dat8
fun_survcurveFibronectin(dat)

```



```{r echo=FALSE ,  warning=FALSE, message=FALSE, fig.width=8, fig.height=6}

fun_hr <- function(dat) {
  library(survminer)
library(survival)
library(arsenal)  # for modelsum
      hr <-  summary(modelsum(Surv(time=RFS_years , event=RFS_c) ~ HLA_DR_ ,  data=dat, family="survival"))
  t1 <- as.data.frame(hr) 
     hr <-  summary(modelsum(Surv(time=RFS_years , event=RFS_c) ~ IDO1_ ,  data=dat, family="survival"))
  t2 <- as.data.frame(hr)
     hr <-  summary(modelsum(Surv(time=RFS_years , event=RFS_c) ~ CD27_ ,  data=dat, family="survival"))
  t3 <- as.data.frame(hr)
     hr <-  summary(modelsum(Surv(time=RFS_years , event=RFS_c) ~ CD40_  ,   data=dat, family="survival"))
  t4 <- as.data.frame(hr)
      hr <-  summary(modelsum(Surv(time=RFS_years , event=RFS_c) ~ CD56_  ,  data=dat, family="survival"))
  t5 <- as.data.frame(hr)
      hr <-  summary(modelsum(Surv(time=RFS_years , event=RFS_c) ~ CD11c_  ,  data=dat, family="survival"))
  t6 <- as.data.frame(hr)
    hr <-  summary(modelsum(Surv(time=RFS_years , event=RFS_c) ~ GZMB_ ,  data=dat, family="survival"))
  t7 <- as.data.frame(hr) 
     hr <-  summary(modelsum(Surv(time=RFS_years , event=RFS_c) ~ PD_L1_ ,  data=dat, family="survival"))
  t8 <- as.data.frame(hr)
     hr <-  summary(modelsum(Surv(time=RFS_years , event=RFS_c) ~ PD_L2_ ,  data=dat, family="survival"))
  t9 <- as.data.frame(hr)
     hr <-  summary(modelsum(Surv(time=RFS_years , event=RFS_c) ~ CD20_  ,   data=dat, family="survival"))
  t10 <- as.data.frame(hr)
      hr <-  summary(modelsum(Surv(time=RFS_years , event=RFS_c) ~ CD3_  ,  data=dat, family="survival"))
  t11 <- as.data.frame(hr)
      hr <-  summary(modelsum(Surv(time=RFS_years , event=RFS_c) ~ CD4_  ,  data=dat, family="survival"))
  t12 <- as.data.frame(hr)
      hr <-  summary(modelsum(Surv(time=RFS_years , event=RFS_c) ~ CTLA4_ ,  data=dat, family="survival"))
  t13 <- as.data.frame(hr) 
     hr <-  summary(modelsum(Surv(time=RFS_years , event=RFS_c) ~ SMA_ ,  data=dat, family="survival"))
  t14 <- as.data.frame(hr)
     hr <-  summary(modelsum(Surv(time=RFS_years , event=RFS_c) ~ CD45_ ,  data=dat, family="survival"))
  t15 <- as.data.frame(hr)
     hr <-  summary(modelsum(Surv(time=RFS_years , event=RFS_c) ~ ICOS_  ,   data=dat, family="survival"))
  t16 <- as.data.frame(hr)
      hr <-  summary(modelsum(Surv(time=RFS_years , event=RFS_c) ~ Fibronectin_  ,  data=dat, family="survival"))
  t17 <- as.data.frame(hr)
     
 

  all <- rbind(t1, t2, t3, t4, t5, t6, t7, t8, t9, t10,t11, t12, t13, t14, t15,t16, t17)
  all 

  colnames(all) <- c("Variables"  ,   "HR"   ,   "L95%CI" ,  "U95%CI",  "Pvalue" ,  "C_index")
  rownames(all) <- NULL
 
  all <- as.data.frame( all)
  return(all)
}



```


# Table1: Hazard ratio and 95% confidence interval based on tumor segments (low_level=reference)

```{r     echo=FALSE ,  warning=FALSE, message=FALSE}
library(survminer)
library(survival)
library(arsenal)  # for modelsum
library(knitr)
dat <- dat1
ab <- fun_hr(dat)

kable(ab)
 
```


# Table2: Hazard ratio and 95% confidence interval based on stroma segments (low_level=reference)

```{r     echo=FALSE ,  warning=FALSE, message=FALSE}
library(survminer)
library(survival) # for surv
library(arsenal)  # for modelsum
library(tidypredict) # for kable
dat <- dat2
ab <- fun_hr(dat)

knitr::kable(ab)

```

# Table3: Hazard ratio and 95% confidence interval based on CD45tumor segments (low_level=reference)

```{r     echo=FALSE ,  warning=FALSE, message=FALSE}
library(survminer)
library(survival) # for surv
library(arsenal)  # for modelsum
library(knitr) # for kable
dat <- dat3
ab <- fun_hr(dat)

knitr::kable(ab)

```

# Table4: Hazard ratio and 95% confidence interval based on CD68tumor segments (low_level=reference)

```{r     echo=FALSE ,  warning=FALSE, message=FALSE}

dat <- dat4
ab <- fun_hr(dat)

knitr::kable(ab)

```

# Table5: Hazard ratio and 95% confidence interval based on tumortumor segments (low_level=reference)

```{r     echo=FALSE ,  warning=FALSE, message=FALSE}

dat <- dat5
ab <- fun_hr(dat)

knitr::kable(ab)

```

# Table6: Hazard ratio and 95% confidence interval based on CD45stroma segments (low_level=reference)

```{r     echo=FALSE ,  warning=FALSE, message=FALSE}

dat <- dat6
ab <- fun_hr(dat)

knitr::kable(ab)

```

# Table7: Hazard ratio and 95% confidence interval based on CD68stroma segments (low_level=reference)

```{r     echo=FALSE ,  warning=FALSE, message=FALSE}

dat <- dat7
ab <- fun_hr(dat)

knitr::kable(ab)

```

# Table8: Hazard ratio and 95% confidence interval based on all segments (low_level=reference)

```{r     echo=FALSE ,  warning=FALSE, message=FALSE}

dat <- dat8
ab <- fun_hr(dat)

knitr::kable(ab)

```






